# =============================================================================
# ARBEES ENVIRONMENT CONFIGURATION - EXAMPLE FILE
# =============================================================================
# Copy this file to .env and fill in your actual values
#
# SECURITY WARNING:
# - NEVER commit .env to git (it's in .gitignore)
# - NEVER use default/example passwords in production
# - Generate secure passwords: openssl rand -base64 32
# - Use secrets management in production (AWS Secrets Manager, etc.)
#
# RESTART INSTRUCTIONS:
# - After modifying any variable, restart the affected container(s)
# - Use: docker compose restart <service_name>
# - Or: docker compose --profile full restart <service_name>
# - For infrastructure changes (DB, Redis), restart dependent services too
# =============================================================================

# =============================================================================
# INFRASTRUCTURE SERVICES
# =============================================================================
# These services are the foundation - many other services depend on them.
# ⚠️  RESTART REQUIRED: timescaledb, redis
# ⚠️  CASCADE RESTART: All services that use DATABASE_URL or REDIS_URL
# 
# Restart command:
#   docker compose restart timescaledb redis
#   docker compose --profile full restart
# =============================================================================

# PostgreSQL/TimescaleDB Configuration
# Used by: timescaledb (and all services via DATABASE_URL)
POSTGRES_USER=arbees
POSTGRES_PASSWORD=CHANGE_ME_USE_SECURE_PASSWORD
POSTGRES_DB=arbees
DATABASE_URL=postgresql://arbees:CHANGE_ME_USE_SECURE_PASSWORD@timescaledb:5432/arbees
DB_PASSWORD=CHANGE_ME_USE_SECURE_PASSWORD

# Redis Configuration
# Used by: redis (and all services via REDIS_URL)
# Note: Redis doesn't use env vars from .env, but services connect via REDIS_URL
REDIS_URL=redis://redis:6379

# =============================================================================
# VPN SERVICE (gluetun)
# =============================================================================
# Provides VPN connectivity for Polymarket monitor (geo-bypass)
# ⚠️  RESTART REQUIRED: vpn, polymarket_monitor
# 
# Restart command:
#   docker compose --profile vpn restart vpn polymarket_monitor
# =============================================================================

NORDVPN_USER=your_nordvpn_username
NORDVPN_PASS=your_nordvpn_password
VPN_COUNTRY=Netherlands  # Optional, defaults to Netherlands
VPN_SERVICE_PROVIDER=nordvpn
OPENVPN_USER=your_nordvpn_username
OPENVPN_PASSWORD=your_nordvpn_password
SERVER_COUNTRIES=Netherlands
FIREWALL_OUTBOUND_SUBNETS=172.16.0.0/12,10.0.0.0/8,192.168.0.0/16
HEALTH_VPN_DURATION_INITIAL=30s

# =============================================================================
# NOTIFICATION SERVICE (notification_service_rust)
# =============================================================================
# Handles Signal notifications via signal-cli-rest-api
# ⚠️  RESTART REQUIRED: notification_service_rust, signal-cli-rest-api
# 
# Restart command:
#   docker compose --profile full restart notification_service_rust signal-cli-rest-api
# 
# Setup (recommended):
# - Start compose profile `full`
# - Open the QR link endpoint on your host (see docker-compose.yml port mapping)
# - Link as a secondary device in Signal mobile (Settings -> Linked devices)
# =============================================================================

# Sender number must be the Signal account linked/registered in signal-cli-rest-api
SIGNAL_SENDER_NUMBER=+15551234567

# Comma-separated phone numbers and/or Signal group ids (group.*)
SIGNAL_RECIPIENTS=+15557654321

SIGNAL_API_BASE_URL=http://signal-cli-rest-api:8080
SIGNAL_API_URL=
MODE=json-rpc

# Quiet hours configuration (notification_service_rust)
QUIET_HOURS_ENABLED=true
QUIET_HOURS_START=22:00
QUIET_HOURS_END=07:00
QUIET_HOURS_TIMEZONE=America/New_York
QUIET_HOURS_MIN_PRIORITY=CRITICAL

# Rate limiting (notification_service_rust)
RATE_LIMIT_MAX_PER_MINUTE=10
RATE_LIMIT_BYPASS_CRITICAL=true

# =============================================================================
# MARKET DISCOVERY SERVICE (market-discovery-rust)
# =============================================================================
# Finds market IDs for games (Polymarket/Kalshi)
# ⚠️  RESTART REQUIRED: market-discovery-rust
# 
# Restart command:
#   docker compose --profile full restart market-discovery-rust
# =============================================================================

# No specific env vars - uses REDIS_URL (shared above)

# =============================================================================
# ORCHESTRATOR SERVICE (orchestrator)
# =============================================================================
# Game discovery via ESPN, shard assignment, health monitoring
# ⚠️  RESTART REQUIRED: orchestrator
# 
# Restart command:
#   docker compose --profile full restart orchestrator
# =============================================================================

# Team matching configuration
TEAM_MATCH_MIN_CONFIDENCE=0.7
MARKET_DISCOVERY_MODE=rust

# Supervisor (container health monitoring + auto-restart)
SUPERVISOR_ENABLED=true
MAX_RESTART_ATTEMPTS=3
RESTART_BACKOFF_SECS=5,15,45
RESTART_COOLDOWN_SECS=600
SUPERVISOR_CHECK_INTERVAL_SECS=15

# Heartbeat settings (used by all Rust services)
HEARTBEAT_INTERVAL_SECS=10
HEARTBEAT_TTL_SECS=35
HEARTBEAT_MISS_THRESHOLD=3

# Kalshi rate limiting - delay between API requests in milliseconds
KALSHI_REQUEST_DELAY_MS=250

# =============================================================================
# GAME SHARD SERVICE (game_shard)
# =============================================================================
# Handles live game state and price monitoring
# ⚠️  RESTART REQUIRED: game_shard
# 
# Restart command:
#   docker compose --profile full restart game_shard
# =============================================================================

SHARD_ID=shard-1
MAX_GAMES_PER_SHARD=20
POLL_INTERVAL=1.0
CRUNCH_TIME_INTERVAL=0.5
HALFTIME_INTERVAL=30.0
MARKET_DATA_TTL=4.0
SYNC_DELTA_TOLERANCE=2.0
SIGNAL_DEBOUNCE_SECS=30
POLYMARKET_VIA_REDIS=true

# MIN_EDGE_PCT: Minimum edge to generate signals and execute trades
#   - Used by both game_shard_rust (signal generation) and signal_processor_rust (execution filtering)
#   - Data shows: 5-10% edge = 36% win rate, 15%+ edge = 87.5% win rate
#   - Set lower for more trades (lower win rate), higher for fewer trades (higher win rate)
#   - Recommended: 15.0% for ~90% win rate, 10.0% for ~77% win rate
MIN_EDGE_PCT=15.0

# =============================================================================
# SIGNAL PROCESSOR SERVICE (signal_processor)
# =============================================================================
# Generates trading signals from arbitrage opportunities
# ⚠️  RESTART REQUIRED: signal_processor
# 
# Restart command:
#   docker compose --profile full restart signal_processor
# =============================================================================

# Risk management limits (tightened after 26x leverage incident)
MAX_DAILY_LOSS=100.0
MAX_GAME_EXPOSURE=50.0
MAX_SPORT_EXPOSURE=200.0
MAX_LATENCY_MS=5000

# Trading parameters (more conservative)
# MIN_EDGE_PCT: Minimum edge percentage (shared by game_shard and signal_processor)
#   - Used by both game_shard_rust (signal generation) and signal_processor_rust (execution filtering)
#   - Default: 5.0% (accounts for round-trip fees with margin: Kalshi ~1.4%, Polymarket ~4%)
#   - Set higher to be more selective, lower to trade more frequently
#   - Recommended: 5.0% for production (accounts for fees with safety margin)
#   - Note: This value applies to both services (env vars are global)
MIN_EDGE_PCT=15.0

# KELLY_FRACTION: Fractional Kelly criterion for position sizing
#   - Used by signal_processor_rust (default: 0.25 = 25% of full Kelly)
#   - Controls how aggressively to size positions based on edge
#   - Lower = more conservative (smaller positions), Higher = more aggressive
KELLY_FRACTION=0.15

MAX_POSITION_PCT=5.0
MAX_BUY_PROB=0.95
MIN_SELL_PROB=0.05
INITIAL_BANKROLL=1000

# Cooldown timers
WIN_COOLDOWN_SECONDS=180
LOSS_COOLDOWN_SECONDS=300

# =============================================================================
# EXECUTION SERVICE (execution_service)
# =============================================================================
# Executes trades (paper/live)
# ⚠️  RESTART REQUIRED: execution_service
# 
# Restart command:
#   docker compose --profile full restart execution_service
# =============================================================================

PAPER_TRADING=1  # Set to "0" for real trading
SLIPPAGE_BPS=10.0

# Note: INITIAL_BANKROLL, MIN_EDGE_PCT, KELLY_FRACTION, MAX_POSITION_PCT
# are also used here (see Signal Processor section above)

# =============================================================================
# POSITION TRACKER SERVICE (position_tracker)
# =============================================================================
# Monitors positions and handles exit logic
# ⚠️  RESTART REQUIRED: position_tracker
# 
# Restart command:
#   docker compose --profile full restart position_tracker
# =============================================================================

# Exit monitoring parameters
TAKE_PROFIT_PCT=5.0
DEFAULT_STOP_LOSS_PCT=5.0
EXIT_CHECK_INTERVAL_SECS=1.0
MIN_HOLD_SECONDS=30
EXIT_TEAM_MATCH_MIN_CONFIDENCE=0.7

# Position tracker hardening
PRICE_STALENESS_TTL=30.0
REQUIRE_VALID_BOOK=true
DEBOUNCE_EXIT_CHECKS=0

# Sport-specific stop-loss thresholds (% probability move against us)
# Higher-scoring sports = tighter stop-loss (more frequent score changes)
# Lower-scoring sports = wider stop-loss (score changes are bigger swings)
STOP_LOSS_NBA=3.0            # Basketball: fast-paced, frequent scoring
STOP_LOSS_NCAAB=3.0          # College basketball: similar to NBA
STOP_LOSS_NFL=5.0            # Football: medium pace, touchdowns = 7pts
STOP_LOSS_NCAAF=5.0          # College football: similar to NFL
STOP_LOSS_NHL=7.0            # Hockey: low scoring, each goal is significant
STOP_LOSS_MLB=6.0            # Baseball: low scoring, but innings can swing
STOP_LOSS_MLS=7.0            # MLS Soccer: low scoring like hockey
STOP_LOSS_SOCCER=7.0         # Soccer: low scoring
STOP_LOSS_TENNIS=4.0         # Tennis: point-by-point volatility
STOP_LOSS_MMA=8.0            # MMA: binary outcome, big swings possible

# =============================================================================
# API SERVICE (api)
# =============================================================================
# FastAPI REST + WebSocket for frontend
# ⚠️  RESTART REQUIRED: api
# 
# Restart command:
#   docker compose --profile full restart api
# =============================================================================

LOG_LEVEL=INFO
RUST_LOG=info

# =============================================================================
# ANALYTICS SERVICE (analytics_service)
# =============================================================================
# Merged archiver + ML analyzer service
# ⚠️  RESTART REQUIRED: analytics_service
# 
# Restart command:
#   docker compose --profile full restart analytics_service
# =============================================================================

# Archiver configuration
ARCHIVER_GRACE_PERIOD_MINUTES=60
ARCHIVER_BATCH_SIZE=10
ARCHIVER_POLL_INTERVAL=300
ARCHIVER_CLEANUP_LIVE_DATA=false

# ML Analyzer configuration
ML_ANALYZER_RUN_TIME=23:00
ML_MIN_TRADES=100
ML_LOOKBACK_DAYS=30
ML_RETRAIN_INTERVAL=7
ML_REPORT_DIR=/app/reports
ML_ENABLE_FILE_DELIVERY=true

# Slack delivery (optional)
ML_SLACK_ENABLED=false
ML_SLACK_WEBHOOK=
ML_SLACK_CHANNEL=

# Email delivery (optional)
ML_EMAIL_ENABLED=false
ML_SMTP_HOST=smtp.gmail.com
ML_SMTP_PORT=587
ML_SMTP_USER=
ML_SMTP_PASSWORD=
ML_EMAIL_FROM=
ML_EMAIL_TO=

# Feedback service configuration
FEEDBACK_MODE=learning
PATTERN_CHECK_INTERVAL=300
FEEDBACK_LOOKBACK_HOURS=24

# =============================================================================
# POLYMARKET MONITOR SERVICE (polymarket_monitor)
# =============================================================================
# Publishes Polymarket prices to Redis (runs through VPN)
# ⚠️  RESTART REQUIRED: polymarket_monitor, vpn
# 
# Restart command:
#   docker compose --profile vpn restart polymarket_monitor vpn
# =============================================================================

POLYMARKET_POLL_INTERVAL_SECONDS=2.0

# =============================================================================
# FRONTEND SERVICE (frontend)
# =============================================================================
# React frontend (no env vars needed - static build)
# ⚠️  RESTART REQUIRED: frontend (only if rebuilt)
# 
# Restart command:
#   docker compose --profile full restart frontend
# =============================================================================

# No environment variables needed

# =============================================================================
# MARKET API CREDENTIALS
# =============================================================================
# Used by: orchestrator, execution_service, market-discovery-rust
# ⚠️  RESTART REQUIRED: orchestrator, execution_service, market-discovery-rust
# 
# Restart command:
#   docker compose --profile full restart orchestrator execution_service market-discovery-rust
# =============================================================================

# Kalshi Prediction Market
# Get your API key from https://kalshi.com/account/api
KALSHI_API_KEY=your_kalshi_api_key
# Provide key as string (escape newlines) or use KALSHI_PRIVATE_KEY_PATH
KALSHI_PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----\n...\n-----END RSA PRIVATE KEY-----"
KALSHI_EMAIL=your_kalshi_email@example.com
KALSHI_PASSWORD=your_kalshi_password

# Polymarket Prediction Market (optional)
POLYMARKET_API_KEY=your_polymarket_api_key

# EU Polymarket Proxy (for regulatory compliance)
# EU_POLYMARKET_PROXY_URL=http://polymarket-proxy.eu-central-1.internal:8080

# =============================================================================
# DEBUG / TRACE LOGGING
# =============================================================================
# Used by: polymarket_monitor (writes to .cursor/debug.log)
# ⚠️  RESTART REQUIRED: polymarket_monitor
# 
# Restart command:
#   docker compose --profile vpn restart polymarket_monitor
# =============================================================================

TRACE_LOGGING_ENABLED=true
DEBUG_LOG_PATH=/app/.cursor/debug.log

# =============================================================================
# LEGACY / UNUSED SETTINGS
# =============================================================================
# These settings are kept for backward compatibility but may not be actively used
# =============================================================================

# InfluxDB Configuration (legacy - not currently used)
# INFLUXDB_TOKEN=your_influxdb_token
# INFLUXDB_ORG=sports-betting
# INFLUXDB_BUCKET=predictions
# INFLUXDB_URL=http://localhost:8086
# INFLUXDB_RETENTION_DAYS=90
# INFLUXDB_SHARD_DURATION=7d

# Grafana Configuration (legacy - not currently used)
# GRAFANA_ADMIN_PASSWORD=admin

# Alert Configuration (legacy - not currently used)
# DISCORD_WEBHOOK=https://discord.com/api/webhooks/your-webhook-url
# TELEGRAM_BOT_TOKEN=your_telegram_bot_token
# TELEGRAM_CHAT_ID=your_telegram_chat_id

# Paper Trading Configuration (legacy - see execution_service section above)
# PAPER_TRADING_INITIAL_BANKROLL=10000
# PAPER_TRADING_STRATEGY=conservative
# MIN_EDGE_THRESHOLD=0.03

# Risk Management (legacy - see signal_processor section above)

# Position policy (legacy - not currently used)
# ALLOW_HEDGING=false

# ZMQ Configuration (legacy - not currently used)
# ZMQ_SUBSCRIBE_ENABLED=true
# ZMQ_SUBSCRIBE_ADDRESS=tcp://raspberrypi:5555

# AWS Configuration (for deployment - not needed for local Docker)
# AWS_ACCESS_KEY_ID=your_access_key_id
# AWS_SECRET_ACCESS_KEY=your_secret_access_key
# AWS_REGION=us-east-1

# Circuit breaker (legacy - not currently used)
# MAX_POSITION_PER_MARKET=50000
# MAX_TOTAL_POSITION=100000
# MAX_CONSECUTIVE_ERRORS=5
# CIRCUIT_BREAKER_COOLDOWN=300
# CIRCUIT_BREAKER_ENABLED=false
